version: 2.1

jobs:
  test:
    machine: true
    steps:
      - checkout
      - run:
          name: Run Poetry Tests
          command: |
            cd ./backend
            pip install --upgrade pip
            pip3 install poetry
            pip3 install -U pip virtualenv
            docker run -d -P -p 127.0.0.1:5432:5432 -e POSTGRES_PASSWORD="1234" -e POSTGRES_DB="postgres_test" --name pg postgres
            sudo apt install python3-dev libpq-dev 
            poetry install
            poetry run uvicorn app.main:app --reload &
            poetry run pytest
            
      - run:
          name: Run Taca Ua Tests
          command: |
            cd ./tacaua-api
            pip install --upgrade pip
            pip3 install poetry
            pip3 install -U pip virtualenv
            docker run -d -P -p 127.0.0.1:5432:5432 -e POSTGRES_PASSWORD="1234" -e POSTGRES_DB="postgres_test" --name pg postgres
            sudo apt install python3-dev libpq-dev 
            poetry install
            poetry run uvicorn app.main:app --reload &
            poetry run pytest
            
workflows:
  build-and-test:
    jobs:
      - test