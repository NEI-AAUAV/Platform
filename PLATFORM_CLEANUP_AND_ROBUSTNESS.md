# Platform Cleanup & Robustness Plan

Comprehensive plan to clean up Platform repository and ensure robust extension management.

---

## üéØ Current State Analysis

### Extension Management Architecture

**‚úÖ Working Well:**
1. Generic extension discovery via `compose.override.yml`
2. Manifest-driven configuration
3. Database schema management
4. External nginx sync (just added)

**‚ö†Ô∏è Issues Found:**
1. **Duplicate nginx configs** (internal proxy + external nginx)
2. **Unused/old scripts** (`generate-external-nginx-configs.sh`)
3. **Duplicate config files** (`nginx-configs/` vs generated in `proxy/`)
4. **Mix of dev and prod concerns** in same directory structure

---

## üìä File Inventory

### Current Nginx Config Locations

#### 1. Internal Proxy (Dev Environment)
```
proxy/
‚îú‚îÄ‚îÄ nginx.conf                      ‚úÖ Used (dev)
‚îú‚îÄ‚îÄ locations.conf                  ‚úÖ Used (dev, core routes)
‚îú‚îÄ‚îÄ locations.rally.conf            üîÑ Generated by manage-extensions.sh
‚îú‚îÄ‚îÄ locations.gala.conf             üîÑ Generated by manage-extensions.sh
‚îî‚îÄ‚îÄ nei.web.ua.pt/
    ‚îú‚îÄ‚îÄ default.conf                ‚úÖ Used (dev)
    ‚îî‚îÄ‚îÄ default.prod.conf           ‚úÖ Used (prod)
```

#### 2. Extension-Specific Configs
```
extensions/rally/proxy/
‚îî‚îÄ‚îÄ locations.conf                  ‚úÖ Used (mounted in compose.override.yml)
```

#### 3. External Nginx Configs (Obsolete?)
```
nginx-configs/
‚îú‚îÄ‚îÄ locations.conf                  ‚ùå Duplicate of proxy/locations.conf
‚îú‚îÄ‚îÄ locations.gala.conf             ‚ùå Duplicate
‚îú‚îÄ‚îÄ locations.rally.conf            ‚ùå Duplicate
‚îî‚îÄ‚îÄ nginx.conf                      ‚ùå Duplicate of proxy/nginx.conf
```

#### 4. Scripts
```
scripts/
‚îú‚îÄ‚îÄ manage-extensions.sh            ‚úÖ Active (just fixed)
‚îú‚îÄ‚îÄ manage-extension-databases.sh   ‚úÖ Active
‚îú‚îÄ‚îÄ generate-external-nginx-configs.sh  ‚ùå Obsolete (superseded by sync to Infrastructure)
‚îî‚îÄ‚îÄ manage-extensions-improved.sh.example  üîÑ Example file
```

---

## üî¥ Files to Remove

### 1. nginx-configs/ Directory - ENTIRE DIRECTORY

**Why:** Superseded by Infrastructure's sites-available/ pattern

The `nginx-configs/` directory contains duplicate configs that were meant for manual copying to external nginx. Now that we have automatic sync to Infrastructure's standalone-nginx, these are obsolete.

```bash
rm -rf nginx-configs/
```

**Impact:** None - External nginx now managed by Infrastructure repo

---

### 2. scripts/generate-external-nginx-configs.sh

**Why:** Superseded by `manage-extensions.sh` + Infrastructure sync

This script was for manually generating configs to copy to external nginx. Now automated.

```bash
rm scripts/generate-external-nginx-configs.sh
```

---

### 3. scripts/manage-extensions-improved.sh.example

**Why:** Just an example file I created for demonstration

```bash
rm scripts/manage-extensions-improved.sh.example
```

---

## üü° Files to Keep But Clean

### 1. proxy/ Directory Structure

**Current Role:** Dev environment internal proxy

**Recommended Changes:**
- Keep for local development
- Clear separation: proxy/ = dev only
- Production uses Infrastructure/nginx (external)

**Action:** Add README clarifying purpose

```bash
cat > proxy/README.md << 'EOF'
# Internal Proxy (Development Only)

This nginx proxy is used **only for local development**.

## Purpose

- Routes requests between dev containers (api_nei, web_nei, extensions)
- Allows testing full platform locally without external infrastructure
- Automatically configured by manage-extensions.sh

## Production

In production, routing is handled by **Infrastructure/nginx** (standalone-nginx).
This internal proxy is not exposed externally in production.

## Files

- `nginx.conf` - Base configuration
- `locations.conf` - Core NEI routes
- `locations.rally.conf` - Generated by manage-extensions.sh (when Rally enabled)
- `locations.gala.conf` - Generated by manage-extensions.sh (when Gala enabled)
- `nei.web.ua.pt/` - Domain-specific configs (not used in dev)

## How It Works

1. `manage-extensions.sh` generates extension-specific location files
2. `compose.yml` mounts these into the proxy container
3. Proxy routes to internal container names (api_rally, web_rally, etc.)

## See Also

- Platform extension management: `../EXTENSIONS.md`
- Infrastructure nginx: `../../Infrastructure/nginx/`
EOF
```

---

### 2. Clarify Extension Proxy Configs

**Issue:** Rally has `extensions/rally/proxy/locations.conf` mounted separately

**Current (Rally compose.override.yml line 45):**
```yaml
- ./extensions/rally/proxy/locations.conf:/etc/nginx/conf.d/locations.rally.conf:ro
```

**This overrides** the generated `proxy/locations.rally.conf`

**Recommendation:** 
- **Option A:** Use generated file (remove extension-specific proxy/)
- **Option B:** Keep extension-specific (remove generation)

**Suggested:** Use generated files for consistency

---

## ‚úÖ Robustness Improvements

### 1. Add Extension Validation Script

Create `scripts/validate-extension.sh`:

```bash
#!/bin/bash
# Validate extension structure and manifest

EXTENSION="${1:-}"

if [[ -z "$EXTENSION" ]]; then
    echo "Usage: $0 <extension-name>"
    exit 1
fi

EXTENSION_DIR="extensions/$EXTENSION"

echo "Validating $EXTENSION extension..."

# Check directory exists
if [[ ! -d "$EXTENSION_DIR" ]]; then
    echo "‚ùå Extension directory not found: $EXTENSION_DIR"
    exit 1
fi

# Check manifest.json
if [[ ! -f "$EXTENSION_DIR/manifest.json" ]]; then
    echo "‚ùå manifest.json not found"
    exit 1
fi

# Validate JSON
if ! jq empty "$EXTENSION_DIR/manifest.json" 2>/dev/null; then
    echo "‚ùå Invalid JSON in manifest.json"
    exit 1
fi

# Check required fields
NAME=$(jq -r '.name // empty' "$EXTENSION_DIR/manifest.json")
API_PORT=$(jq -r '.api.port // empty' "$EXTENSION_DIR/manifest.json")
WEB_PORT=$(jq -r '.web.port // empty' "$EXTENSION_DIR/manifest.json")

if [[ -z "$NAME" ]]; then
    echo "‚ùå Missing 'name' in manifest.json"
    exit 1
fi

echo "‚úì manifest.json valid"

# Check compose.override.yml
if [[ ! -f "$EXTENSION_DIR/compose.override.yml" ]]; then
    echo "‚ùå compose.override.yml not found"
    exit 1
fi

echo "‚úì compose.override.yml exists"

# Check API directory
if [[ ! -d "$EXTENSION_DIR/api-$EXTENSION" ]]; then
    echo "‚ö†Ô∏è  API directory not found: api-$EXTENSION"
fi

# Check Web directory
if [[ ! -d "$EXTENSION_DIR/web-$EXTENSION" ]]; then
    echo "‚ö†Ô∏è  Web directory not found: web-$EXTENSION"
fi

echo ""
echo "‚úì $EXTENSION extension is valid"
echo "  Name: $NAME"
echo "  API Port: $API_PORT"
echo "  Web Port: $WEB_PORT"
```

---

### 2. Add Pre-deployment Checks

Create `scripts/pre-deploy-check.sh`:

```bash
#!/bin/bash
# Pre-deployment validation

set -e

echo "=== Pre-Deployment Checks ==="
echo ""

# Check ENABLED_EXTENSIONS
echo "1. Checking ENABLED_EXTENSIONS..."
if [[ -z "$ENABLED_EXTENSIONS" ]]; then
    echo "‚ö†Ô∏è  ENABLED_EXTENSIONS not set (will disable all extensions)"
else
    echo "‚úì ENABLED_EXTENSIONS='$ENABLED_EXTENSIONS'"
fi

# Validate each enabled extension
if [[ -n "$ENABLED_EXTENSIONS" ]]; then
    echo ""
    echo "2. Validating enabled extensions..."
    IFS=',' read -ra EXTENSIONS <<< "$ENABLED_EXTENSIONS"
    for ext in "${EXTENSIONS[@]}"; do
        ext=$(echo "$ext" | xargs)
        if ./scripts/validate-extension.sh "$ext"; then
            echo "‚úì $ext validated"
        else
            echo "‚ùå $ext validation failed"
            exit 1
        fi
    done
fi

# Check docker is running
echo ""
echo "3. Checking Docker..."
if docker ps > /dev/null 2>&1; then
    echo "‚úì Docker is running"
else
    echo "‚ùå Docker is not running"
    exit 1
fi

# Check database connectivity
echo ""
echo "4. Checking database..."
if docker ps | grep -q "db_pg"; then
    echo "‚úì PostgreSQL container running"
else
    echo "‚ö†Ô∏è  PostgreSQL container not running"
fi

# Check external nginx (if in production)
if [[ "$ENVIRONMENT" == "production" ]]; then
    echo ""
    echo "5. Checking external nginx..."
    if docker ps -a --format "{{.Names}}" | grep -q "^standalone-nginx$"; then
        echo "‚úì standalone-nginx container found"
    else
        echo "‚ö†Ô∏è  standalone-nginx container not found"
    fi
fi

echo ""
echo "‚úì All pre-deployment checks passed"
```

---

### 3. Add Post-deployment Verification

Create `scripts/verify-deployment.sh`:

```bash
#!/bin/bash
# Verify deployment succeeded

echo "=== Deployment Verification ==="
echo ""

# Check core containers
echo "1. Checking core containers..."
CORE_CONTAINERS=("api_nei" "web_nei" "proxy" "db_pg")
for container in "${CORE_CONTAINERS[@]}"; do
    if docker ps | grep -q "$container"; then
        echo "‚úì $container running"
    else
        echo "‚ùå $container not running"
        exit 1
    fi
done

# Check enabled extensions
if [[ -n "$ENABLED_EXTENSIONS" ]]; then
    echo ""
    echo "2. Checking extension containers..."
    IFS=',' read -ra EXTENSIONS <<< "$ENABLED_EXTENSIONS"
    for ext in "${EXTENSIONS[@]}"; do
        ext=$(echo "$ext" | xargs)
        
        API_CONTAINER="platform_api_${ext}_1"
        WEB_CONTAINER="platform_web_${ext}_1"
        
        if docker ps | grep -q "$API_CONTAINER"; then
            echo "‚úì $ext API running"
        else
            echo "‚ùå $ext API not running"
            exit 1
        fi
        
        if docker ps | grep -q "$WEB_CONTAINER"; then
            echo "‚úì $ext Web running"
        else
            echo "‚ùå $ext Web not running"
            exit 1
        fi
    done
fi

# Test endpoints
echo ""
echo "3. Testing endpoints..."
echo "   (Basic connectivity check)"

# Core platform
if curl -sf http://localhost:80/ > /dev/null 2>&1; then
    echo "‚úì Platform accessible"
else
    echo "‚ö†Ô∏è  Platform not accessible at http://localhost:80/"
fi

echo ""
echo "‚úì Deployment verification complete"
```

---

## üìã Complete Cleanup Script

```bash
#!/bin/bash
# Complete Platform cleanup

cd /path/to/Platform

echo "=== Platform Cleanup ==="
echo ""

# Remove obsolete directories
echo "1. Removing obsolete nginx-configs/..."
rm -rf nginx-configs/

# Remove obsolete scripts
echo "2. Removing obsolete scripts..."
rm -f scripts/generate-external-nginx-configs.sh
rm -f scripts/manage-extensions-improved.sh.example

# Create proxy README
echo "3. Adding proxy/ documentation..."
cat > proxy/README.md << 'EOF'
# Internal Proxy (Development Only)

This nginx proxy is used **only for local development**.
Production routing is handled by Infrastructure/nginx.

See ../EXTENSIONS.md for more information.
EOF

# Git status
echo ""
echo "4. Checking git status..."
git status

# Commit
echo ""
read -p "Commit changes? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    git add -A
    git commit -m "Clean up obsolete nginx configs and scripts

Removed:
- nginx-configs/ - Superseded by Infrastructure sites-available pattern
- generate-external-nginx-configs.sh - Superseded by manage-extensions.sh sync
- Example files

Added:
- proxy/README.md - Clarify dev-only purpose
- Validation scripts for robustness"
    
    echo "‚úì Changes committed"
fi
```

---

## üéØ Implementation Checklist

### Phase 1: Cleanup (Now)
- [ ] Remove `nginx-configs/` directory
- [ ] Remove `generate-external-nginx-configs.sh`
- [ ] Remove example files
- [ ] Add `proxy/README.md`
- [ ] Commit changes

### Phase 2: Robustness (Next)
- [ ] Create `validate-extension.sh`
- [ ] Create `pre-deploy-check.sh`
- [ ] Create `verify-deployment.sh`
- [ ] Update `start-platform.sh` to call pre-deploy checks
- [ ] Update `EXTENSIONS.md` with new scripts

### Phase 3: Refinement (Later)
- [ ] Decide on extension-specific proxy configs (rally has its own)
- [ ] Consider moving proxy configs to extension directories
- [ ] Add monitoring hooks
- [ ] Add rollback automation

---

## üìê Architecture Clarity

### Development Environment
```
Platform/
‚îú‚îÄ‚îÄ proxy/                    ‚Üê Dev-only internal nginx
‚îÇ   ‚îî‚îÄ‚îÄ locations.*.conf      ‚Üê Generated by manage-extensions.sh
‚îú‚îÄ‚îÄ extensions/
‚îÇ   ‚îî‚îÄ‚îÄ rally/
‚îÇ       ‚îî‚îÄ‚îÄ proxy/            ‚Üê Extension-specific config (optional)
```

### Production Environment
```
Infrastructure/nginx/
‚îú‚îÄ‚îÄ sites-available/          ‚Üê All configs
‚îÇ   ‚îú‚îÄ‚îÄ 00-core.conf
‚îÇ   ‚îî‚îÄ‚îÄ 10-rally.conf
‚îî‚îÄ‚îÄ sites-enabled/            ‚Üê Active configs (symlinks)
    ‚Üê Synced by Platform's manage-extensions.sh
```

**Flow:**
1. Platform: `manage-extensions.sh` manages containers
2. Platform: `sync_external_nginx()` calls Infrastructure sync
3. Infrastructure: `sync-extensions.sh` creates symlinks
4. Infrastructure: nginx reloads with new config

---

## üöÄ Benefits After Cleanup

1. **Clearer separation** - Dev vs Prod clearly defined
2. **No duplication** - Single source of truth per environment
3. **Automatic sync** - No manual config copying
4. **Validation** - Pre-deploy checks prevent issues
5. **Easier onboarding** - Clear documentation of what goes where

---

## üìù Summary

**Files to delete:**
- `nginx-configs/` (entire directory)
- `scripts/generate-external-nginx-configs.sh`
- `scripts/manage-extensions-improved.sh.example`

**Space reclaimed:** ~15 KB

**New robustness features:**
- Extension validation
- Pre-deployment checks
- Post-deployment verification

**Time to implement:** 30-45 minutes

